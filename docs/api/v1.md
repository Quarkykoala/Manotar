# Manobal API v1 Documentation

This document provides details about the API endpoints available in version 1 of the Manobal mental health platform API.

## Base URL

All API endpoints are accessible at `/api/v1/`.

## Authentication

Most endpoints require authentication via JWT tokens. To authenticate:

1. Obtain a token via the `/api/v1/auth/login` endpoint
2. Include the token in the `Authorization` header: `Authorization: Bearer <your_token>`

## Endpoints

### Authentication

#### `POST /api/v1/auth/login`

Authenticates a user and returns a JWT token.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "password"
}
```

**Response:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "role": "hr"
  },
  "expires_at": "2023-07-01T12:00:00Z"
}
```

#### `POST /api/v1/auth/register`

Registers a new HR user (admin access required).

**Request Body:**
```json
{
  "email": "newhr@example.com",
  "password": "password123",
  "name": "HR Manager",
  "department": "Human Resources"
}
```

**Response:**
```json
{
  "message": "User created successfully",
  "user_id": 5
}
```

### Dashboard Data

#### `GET /api/v1/dashboard`

Returns overall dashboard data with sentiment scores and counts.

**Response:**
```json
{
  "overall_sentiment": 0.72,
  "sentiment_category": "positive",
  "department_count": 5,
  "employee_count": 120,
  "message_count": 1450,
  "department_stats": [
    {"name": "Engineering", "sentiment": 0.68, "count": 42},
    {"name": "Marketing", "sentiment": 0.75, "count": 28},
    {"name": "HR", "sentiment": 0.81, "count": 15}
  ]
}
```

#### `GET /api/v1/dashboard/department-comparison`

Provides sentiment comparison data across departments.

**Query Parameters:**
- `time_period`: "week", "month", "quarter", "year" (default: "month")

**Response:**
```json
{
  "departments": [
    {
      "name": "Engineering",
      "sentiment": 0.68,
      "employee_count": 42,
      "message_count": 520,
      "trend": "+0.05"
    },
    {
      "name": "Marketing",
      "sentiment": 0.75,
      "employee_count": 28,
      "message_count": 310,
      "trend": "-0.02"
    }
  ],
  "time_period": "month"
}
```

#### `GET /api/v1/dashboard/time-series`

Returns time series data for sentiment trends.

**Query Parameters:**
- `department`: Department name (optional)
- `time_period`: "week", "month", "quarter", "year" (default: "month")
- `granularity`: "day", "week", "month" (default depends on time_period)

**Response:**
```json
{
  "data": [
    {"date": "2023-06-01", "sentiment": 0.71},
    {"date": "2023-06-02", "sentiment": 0.73},
    {"date": "2023-06-03", "sentiment": 0.69}
  ],
  "department": "All",
  "time_period": "month",
  "granularity": "day"
}
```

#### `GET /api/v1/dashboard/department/{department}/details`

Retrieves detailed information for a specific department.

**Path Parameters:**
- `department`: Department name

**Response:**
```json
{
  "name": "Engineering",
  "sentiment": 0.68,
  "employee_count": 42,
  "message_count": 520,
  "top_emotions": [
    {"name": "focus", "score": 0.75},
    {"name": "satisfaction", "score": 0.62},
    {"name": "stress", "score": 0.48}
  ],
  "keyword_stats": [
    {"keyword": "deadline", "count": 28},
    {"keyword": "project", "count": 35},
    {"keyword": "meeting", "count": 22}
  ]
}
```

#### `GET /api/v1/dashboard/keyword-stats`

Provides keyword statistics across all departments.

**Query Parameters:**
- `department`: Department name (optional)
- `time_period`: "week", "month", "quarter", "year" (default: "month")
- `limit`: Number of keywords to return (default: 20)

**Response:**
```json
{
  "keywords": [
    {"keyword": "deadline", "count": 86, "departments": ["Engineering", "Marketing"]},
    {"keyword": "meeting", "count": 72, "departments": ["All"]},
    {"keyword": "stress", "count": 65, "departments": ["All"]}
  ],
  "time_period": "month"
}
```

### WhatsApp Bot

#### `POST /api/v1/bot/webhook`

Twilio webhook endpoint for the WhatsApp bot.

**Request Body (from Twilio):**
```
Body=Hello bot, I'm feeling stressed today
From=whatsapp:+1234567890
To=whatsapp:+0987654321
ProfileName=John Doe
```

**Response:**
A Twilio-compatible XML response or JSON with the bot's reply.

### Employee Management

#### `GET /api/v1/employees`

Lists all employees (anonymized).

**Query Parameters:**
- `department`: Filter by department (optional)
- `page`: Page number (default: 1)
- `per_page`: Items per page (default: 20)

**Response:**
```json
{
  "employees": [
    {
      "id": "EMP001",
      "department": "Engineering",
      "average_sentiment": 0.72,
      "message_count": 45,
      "last_active": "2023-06-30T15:43:21Z"
    }
  ],
  "page": 1,
  "per_page": 20,
  "total": 120
}
```

## Error Handling

All API endpoints return standard HTTP status codes with error messages in JSON format:

```json
{
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Invalid email or password",
    "status": 401
  }
}
```

## Rate Limiting

API requests are limited to 100 requests per minute per IP address. When exceeded, a 429 Too Many Requests status is returned.

## Data Privacy

All employee data is anonymized. No personally identifiable information is available through the API unless specifically required for administrative functions (with appropriate permissions).

## Versioning Policy

When breaking changes are needed, a new API version will be created. Version 1 endpoints will remain available for at least 6 months after a newer version is released. 